import argparse
import os
import textwrap
from datetime import datetime
import yaml

arguments_dictionary = {
    "directory_path": "",
    "log_filename": "",
    "keywords": [],
    "timestamp_format": "",
}


def load_yaml_configuration():
    with open("scanner_config.yml", "r", encoding="utf-8") as scanner_config:
        scanner_arguments = yaml.safe_load(scanner_config)
        arguments_dictionary["directory_path"] = scanner_arguments["directory_path"]
        arguments_dictionary["log_filename"] = scanner_arguments["log_filename"]
        arguments_dictionary["keywords"] = scanner_arguments["keywords"]
        arguments_dictionary["timestamp_format"] = scanner_arguments["timestamp_format"]


def parse_arguments():
    parser = argparse.ArgumentParser(description="Parser for arguments")
    parser.add_argument("-p", "--path", help="Path to directory")
    args = parser.parse_args()
    return args.path


def read_all_files(path):
    information_dictionary = {
        "file_count": 0,
        "file_virus_count": 0,
        "file_virus_info": [],
    }
    file_list = os.listdir(path)

    for file in file_list:
        file_path = os.path.join(path, file)
        if not os.path.isfile(file_path):
            continue
        with open(file_path, "r") as f:
            data = f.read()
            for keyword in arguments_dictionary["keywords"]:
                if keyword in data:
                    information_dictionary["file_virus_count"] += 1
                    timestamp = datetime.now().strftime(
                        arguments_dictionary["timestamp_format"]
                    )
                    information_dictionary["file_virus_info"].append([file, timestamp])
        information_dictionary["file_count"] += 1

    with open(arguments_dictionary["log_filename"], "a") as log_file:
        for filename, time in information_dictionary["file_virus_info"]:
            log_file.write(f"[{time}]: virus was detected in {filename}" + "\n")

    return information_dictionary


def main():

    load_yaml_configuration()
    path = parse_arguments()

    if not path:
        path = arguments_dictionary["directory_path"]

    if not os.path.isdir(path):
        print("Path must be only to a directory")
        return

    information_dictionary = read_all_files(path)
    print(
        textwrap.dedent(
            f"""
            File was procceed: {information_dictionary['file_count']} 
            Was found viruses in {information_dictionary['file_virus_count']}
            """
        )
    )


if __name__ == "__main__":
    main()
